---
id: 102
title: Use a git-hook to deploy your app
date: 2018-08-28T13:07:10+00:00
author: Aike
layout: post
guid: http://www.runrails.com/?p=102
permalink: /deploying/use-a-git-hook-to-deploy-your-app/
categories:
  - Deploying
---
There are a lot of ways to deploy an app to a server, here is a simple one that I often use. This can be a bit confusing if you are not familiar with Git but I promise it&#8217;s the easiest way!

It works like this: you create an empty git repository on the server and you push the branch you want to this reposity from your development machine. The repository on the server has a little script (hook) that puts the files in the right directory (&#8216;rails_project&#8217;) and runs all the bundle commands. You end up with 2 directories: the bare repository and the &#8216;checkout&#8217; with the project.<!--more-->

### 1. Create the bare repository on the server

Login to the server with the user account you want to use to run the application and create the bare repository in the home directory.

<pre class="lang:default decode:true ">mkdir bare-repository 

cd bare-repository

git init --bare</pre>

or as a oneliner:

<pre class="lang:default decode:true">mkdir bare-repository && cd $_ && git init --bare</pre>

You can&#8217;t really interact with a bare repository the way you do with a normal repository. But you can push to it and let it automatically run hooks on the server. That&#8217;s enough for this setup.

We also need a directory for the checkout, let&#8217;s create that as well. I use a generic name for the checkout so I don&#8217;t have to change my scripts on every server. I like &#8216;rails_project&#8217; or just &#8216;checkout&#8217;.

<pre class="lang:default decode:true ">mkdir ~/rails_project</pre>

### 2. Install the commit hook (script)

The application will not run out of the bare repository directory. That&#8217;s just where we push the code to. The post-receive hook will check out the code from the bare repository to the &#8216;rails_project&#8217; directory.

Go back to your home directory with &#8216;cd&#8217; and edit the post-receive hook:

<pre class="lang:default decode:true">nano bare-repository/hooks/post-receive</pre>

We need to add a command to do the checkout and run bundle install for us. We&#8217;ll add more functionality later.

<pre class="lang:default decode:true">GIT_WORK_TREE=~/rails_project git checkout -f
cd ~/rails_project
bundle install --without development test</pre>

This will check out the code in the bare repository to the directory &#8216;rails_project&#8217; and run bundle install in it. Your git client on your machine will show you the output generated by this script after the usual notifications.

And give this post-receive hook enough permissions to run:

<pre class="lang:default decode:true">chmod a+x bare-repository/hooks/post-receive</pre>

&nbsp;

### 3. Let&#8217;s add the remote and push something

To add the bare-repository on the server as a remote to your local git repository use:

<pre class="lang:default decode:true">git remote add newserver rails@test.runrails.com:bare-repository</pre>

You have to run this command on your development machine, not the server. The &#8216;newserver&#8217; is just the name of the remote, you can call it whatever you like. I often have &#8216;staging&#8217; or &#8216;production&#8217;.

And push the master branch to the server. Again, newserver is the name of the remote and master is the name of the branch you want to push to it.

<pre class="lang:default decode:true">git push newserver master</pre>

You will see the output of the post-receive hook in your terminal or Git client. To push the same code again if something was wrong on the server create an empty commit and push again.

<pre class="lang:default decode:true ">git commit --allow-empty
git push newserver master</pre>

### 4. Improvements and troubleshooting

If you use RVM the bundle install part won&#8217;t work. You have to use the rvm bundle wrapper like this:

<pre class="lang:default decode:true ">/usr/local/rvm/gems/ruby-2.4.0/wrappers/bundle install --without development test</pre>

There is no rollback option like with capistrano in with this deployment method but it&#8217;s easy to add a database backup to the script with:

<pre class="lang:default decode:true ">pg_dump your_db_production &gt; ~/pgdump_before_deploy.sql</pre>

And you can login with ssh and migrate your database by hand, but it&#8217;s much easier to add it to the post-receive hook. Same for assets:precompile

<pre class="lang:default decode:true">bundle exec rake db:migrate
bundle exec rake assets:precompile</pre>

Touch restart.txt to automatically restart your rails app if you use Passenger:

<pre class="lang:default decode:true ">touch ~/rails_project/tmp/restart.txt</pre>

And if your script generates a lot of output, you might want to add an error notification in case something goes wrong. Add this block to the top of the hook:

<pre class="lang:default decode:true">#!/bin/bash
exit_with_error() {
  echo "[DEPLOY] !!!!!!!!!!!!!!!!!!!! An error has occurred !!!!!!!!!!!!!!!!!!!!!!!"
  exit 1
}</pre>

and add  **||** exit\_with\_error after each command you want to be notified about. For example:

<pre class="lang:default decode:true ">bundle exec rake assets:precompile || exit_with_error</pre>

&nbsp;

That&#8217;s all. Let me know if you have any questions about this method or found any mistakes. You can email me on <info@runrails.com> or Tweet to me at [@runrails.com](https://twitter.com/runrails)